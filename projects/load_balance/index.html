<meta charset="utf-8">
**大型绘制系统的负载平衡算法**
 [[代码](https://github.com/xuechao-chen/RegressionForest)]
 ![](teaser.jpg)


# 项目简介

大型绘制系统，如飞行模拟系统，通常需要GPU集群进行并行渲染以满足实时的要求。将绘制帧分块分发到不同的GPU上渲染涉及到负载平衡算法的优化。优化的目标是使得分发的绘制块的渲染时间与相应的GPU处理能力成正比，使得所有绘制块在相同时间内渲染完成。

由于绘制帧的不同像素/区域的渲染时间存在较大的差异，采用平均分块进行分发导致部分GPU空闲以及总体绘制时间加长。利用帧间相关性可以在绘制完一帧后获取各分块的绘制时间，进而根据上一帧各分块的绘制时间进行分块调整。然而，场景/光照条件的变化会破坏帧间相关性，导致基于帧间相关的分块调整失效。这归结于无法在绘制前获取各分块的绘制时间来进行优化调整。

本课题尝试在渲染发生前预测给定分块方式的各分块绘制时间。基于预测的各分块绘制时间，进行多次迭代“预测-分块调整“来得到最优的负载分发方式。观察到，分块的渲染时间与该分块采用的渲染算法特征密切相关，如采用OIT算法渲染时，分块出现的透明物体面积占比越大，绘制时间越长。这样的特征可以在实时中获取，并使用机器学习方法来预测其绘制时间。

项目采用`C++`和`HIVE`引擎实现，使用`openmp`进行多线程加速，绘制系统包含LLL,OIT,以及SSAO主要绘制算法，代码行数约4k。

# 主要流程

(##) 构建高性能并行的回归森林

我们基于一下几点考虑，选用回归森林模型进行分块绘制时间的预测。

- 回归森林调参简单，鲁棒性好，具有不错的可解释性
- 回归森林由独立的决策树组成，易于并行化进行训练和预测，适合对性能要求高的实时应用

我们使用了`openmp`线程库以及C++重新实现了高性能并行的回归森林，将100棵决策树组成的回归森林的预测性能提升到纳秒级别，训练时间也大幅降低。这使得回归森林被用于大型渲染系统的实时多次迭代负载预测与调度成为可能。

(##) 训练数据的采集与训练

采用多种复杂绘制算法的并行渲染系统的相机视点/位置，渲染实体（光源/透明物体等）的位置和数量，负载分块的位置等在每一帧都独立发生变化，从而组合成巨大的参数空间。对参数空间可能组合得到的数据进行采集是不切实际的。观察到，在实际的渲染系统中，用户的漫游路径(视点移动)常常符合少数的固定模式，负载分块位置集中在负载平衡的分块位置附近。这可以引导我们采用更有效的训练数据采集方式：

- 收集用户漫游习惯，形成漫游路径集，在采集数据时依据漫游路径进行漫游采集

- 使用帧间相关性算法进行分块调整，调整到负载平衡位置，从负载平衡位置出发进行基于高斯分布的分块位置调整，充分采集负载平衡位置附近的分块渲染数据
- 具体采集的特征包括：分块特征，视点特征，渲染算法特征，渲染时间。

基于采集好的训练数据，使用先前构建的并行化回归森林进行模型训练，将训练好的模型序列化保存以便运行时加载进行实时预测。

(##) 基于训练模型的运行时负载调度

在运行时阶段，基于模型的预测时间来迭代调整分块方式，达到负载平衡的理想条件。“预测-调度”的主要思想是首先从平均分块位置出发进行预测，根据预测结果使用贪心算法进行分块调整，得到新的分块位置，重复进行”预测-调整“直至达到负载平衡位置或者达到最大调整次数。

<!-- Markdeep: -->

<style class="fallback">body{visibility:hidden;white-space:pre;font-family:monospace}</style><script src="markdeep.min.js" charset="utf-8"></script><script src="https://casual-effects.com/markdeep/latest/markdeep.min.js" charset="utf-8"></script><script>window.alreadyProcessedMarkdeep||(document.body.style.visibility="visible");markdeepOptions = {tocStyle:'none'};</script>